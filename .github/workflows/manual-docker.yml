name: Manually deploy docker

on:
  workflow_dispatch:
    inputs:
      branch:
        type: string
        description: branch to build
      latest:
        type: boolean
        description: Build as latest

jobs:
  publish-miner:
    name: Publish Miner on DockerHub
    runs-on: ubuntu-latest
    concurrency: miner_docker
    environment: DockerHub
    steps:
      - name: Checkout source
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.inputs.branch }}
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ vars.JAVA_VERSION }}
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4.4.4

      - name: Calculate miner image name
        id: miner-image-name
        run: |
          echo "IMAGE_NAME=${{ vars.DOCKER_IMAGE_MINER }}:${GITHUB_REF##*/}" >> "$GITHUB_OUTPUT"
          echo "IMAGE_NAME_LATEST=${{ vars.DOCKER_IMAGE_MINER }}:latest" >> "$GITHUB_OUTPUT"
      - name: Push branch/tag on Docker Hub
        run: |
          ./gradlew \
          :miner:jib \
          -Djib.to.auth.username=${{ secrets.DOCKER_USERNAME }} \
          -Djib.to.auth.password=${{ secrets.DOCKER_TOKEN }} \
          -Djib.to.image=${{ steps.miner-image-name.outputs.IMAGE_NAME }}
      - name: Push latest on Docker Hub
        if: success() && github.event.inputs.latest == 'true'
        run: |
          ./gradlew \
          :miner:jib \
          -Djib.to.auth.username=${{ secrets.DOCKER_USERNAME }} \
          -Djib.to.auth.password=${{ secrets.DOCKER_TOKEN }} \
          -Djib.to.image=${{ steps.miner-image-name.outputs.IMAGE_NAME_LATEST }}

  publish-viewer:
    name: Publish Viewer on DockerHub
    runs-on: ubuntu-latest
    concurrency: viewer_docker
    environment: DockerHub
    steps:
      - name: Checkout source
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.inputs.branch }}
      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ vars.JAVA_VERSION }}
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4.4.4

      - name: Calculate viewer image name
        id: viewer-image-name
        run: |
          echo "IMAGE_NAME=${{ vars.DOCKER_IMAGE_VIEWER }}:${GITHUB_REF##*/}" >> "$GITHUB_OUTPUT"
          echo "IMAGE_NAME_LATEST=${{ vars.DOCKER_IMAGE_VIEWER }}:latest" >> "$GITHUB_OUTPUT"
      - name: Push branch/tag on Docker Hub
        run: |
          ./gradlew \
          :viewer:jib \
          -Djib.to.auth.username=${{ secrets.DOCKER_USERNAME }} \
          -Djib.to.auth.password=${{ secrets.DOCKER_TOKEN }} \
          -Djib.to.image=${{ steps.viewer-image-name.outputs.IMAGE_NAME }}
      - name: Push latest on Docker Hub
        if: success() && github.event.inputs.latest == 'true'
        run: |
          ./gradlew \
          :viewer:jib \
          -Djib.to.auth.username=${{ secrets.DOCKER_USERNAME }} \
          -Djib.to.auth.password=${{ secrets.DOCKER_TOKEN }} \
          -Djib.to.image=${{ steps.viewer-image-name.outputs.IMAGE_NAME_LATEST }}
